<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtos</title>
    <link rel="stylesheet" href="style/cadastro-produto-style.css">
    <!-- Bootstrap CSS -->
       <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    <link rel="icon" href="./imgs/logo.png" crossorigin>
    <link rel="shortcut icon" href="#">
</head>
<body>
    <header>
        <a href="produtos.html"><img class="logo" src="imgs/logo.png" alt="Logo da EstoqueMaster"></a>
        <button class="btn-entre" onclick="window.location.href = 'config-conta.html'">Minha conta</button>
    </header>

    <section class="m-4 w-full">
        <div id="titulo" class="bg-primary d-flex text-white py-1 px-5 rounded w-100 justify-content-center">
            <p>Cadastrar Novo Produto</p>
        </div>

        <form id="cadastroProduto">
            <div class="row flex mt-4">
                
<div id="foto" class="col-sm-5">
    <div class="bg-primary text-white py-1 rounded-top w-100 d-flex justify-content-around">
        <p>Foto</p>
        <button id="btnAddImg" type="button" class="btn btn-primary btn-sm" onclick="openImageInput()">Adicionar Imagem</button>
    </div>
    <img id="campoImagem" class="object-fit-contain w-100" src="./imgs/logo.png" alt="Imagem do Produto"
        height="200px" width="200px">
</div>

<!-- Add a hidden input field for image URL -->
<input id="inputImageUrl" type="text" style="display: none;">

                <div id="info" class="col">
                    <div class="row row-col-3">
                        <div id="nome" class="col-sm-12">
                            <div class="bg-primary text-white py-1 px-5 rounded-top w-100">Nome:</div>
                            <input id="campoNome" type="text" class="bg-info-subtle p-2 w-100 h-100 rounded-bottom"
                                placeholder="Digite o nome, marca e modelo" required></input>
                        </div>

                        <div id="descricao" class="col-sm-12 mt-5">
                            <div class="bg-primary text-white py-1 px-5 rounded-top w-100">Descrição:</div>
                            <input id="campoDescricao" type="text" class="bg-info-subtle p-2 w-100 h-100 rounded-bottom"
                                placeholder="Digite uma descrição para o seu produto." required></input>
                        </div>

                        <div id="estq-atual" class="col-sm-4 mt-5">
                            <div class="bg-primary text-white py-1 px-5 rounded-top w-100">Estoque Atual:</div>
                            <input id="campoEstq-atual" type="number" class="bg-info-subtle p-2 w-100 h-100 rounded-bottom text-center fs-4 fw-semibol"
                                placeholder="0" required></input>
                        </div>

                        <div id="estq-min" class="col-sm-4 mt-5">
                            <div class="bg-primary text-white py-1 px-5 rounded-top w-100">Estoque Mínimo:</div>
                            <input id="campoEstq-min" type="number" class="bg-info-subtle p-2 w-100 h-100 rounded-bottom text-center fs-4 fw-semibol"
                                placeholder="0" required></input>
                        </div>

                        <div id="valor-compra" class="col-sm-4 mt-5">
                            <div class="bg-primary text-white py-1 px-5 rounded-top w-100">Valor de Compra:</div>
                            <input id="campoValor-compra" type="number" step="0.01" class="bg-info-subtle p-2 w-100 h-100 rounded-bottom text-center fs-4 fw-semibol"
                                placeholder="0" required></input>
                        </div>

                        <div id="valor-venda" class="col-sm-4 mt-5">
                            <div class="bg-primary text-white py-1 px-5 rounded-top w-100">Valor de Venda:</div>
                            <input id="campoValor-venda" type="number" step="0.01" class="bg-info-subtle p-2 w-100 h-100 rounded-bottom text-center fs-4 fw-semibol"
                                placeholder="0" required></input>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row d-flex mb-4 mt-4">
                <div id="Categoria" class="col-sm-5 mt-4 flex flex-column">
                    <div class="bg-secondary-subtle py-1 px-5 rounded w-100 mt-5">
                        <b>Dica EstoqueMaster:</b> Assine o modo premium para acessar as ferramentas de IA!
                    </div>
                </div>
            </div>

            <div>
                <button id="btnsalvar" type="button" class="btn-salvar" onclick="submitForm()">Salvar</button>
                <a href="produtos.html">
                    <button id="btnvoltar" type="button" class="btn-voltar bg-secondary">Voltar</button>
                </a>
            </div>
        </form>
    </section>

        <script>
        // Get the URL query parameters
const urlParams = new URLSearchParams(window.location.search);

// Get the value of the 'id' parameter
const productId = urlParams.get('id');

// Use the 'productId' in your code
console.log(`Product ID: ${productId}`);

// Check if productId is not null
if (productId !== null) {
    // Retrieve the existing product data
    fetch(`/products/${productId}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
    .then(response => {
        if (response.status === 200) {
            return response.json(); // Assuming the response is in JSON format
        } else {
            throw new Error("Failed to retrieve product data");
        }
    })
    .then(productData => {
        // Populate the input fields with the existing product data
        document.getElementById("campoNome").value = productData.nome;
        document.getElementById("campoEstq-atual").value = productData.amount;
        document.getElementById("campoEstq-min").value = productData.min_amount;
        document.getElementById("campoDescricao").value = productData.description;
        document.getElementById("campoValor-compra").value = productData.buyingPrice;
        document.getElementById("campoValor-venda").value = productData.sellingPrice;
        // Set the image source
        document.getElementById("campoImagem").src = productData.img;
    })
    .catch(error => {
        alert(error);
    });
}              
    function submitForm() {
    const productId = urlParams.get('id'); // Get the product ID from the query parameters

    // Retrieve the values from the input fields
    const nome = document.getElementById("campoNome").value;
    const amount = parseInt(document.getElementById("campoEstq-atual").value);
    const min_amount = parseInt(document.getElementById("campoEstq-min").value);
    const description = document.getElementById("campoDescricao").value;
    const buyingPrice = parseFloat(document.getElementById("campoValor-compra").value);
    const sellingPrice = parseFloat(document.getElementById("campoValor-venda").value);
    const providerCNPJ = 123456789;
    const imgElement = document.getElementById("campoImagem");
    const img_url = imgElement.src;

    // Create the JSON data object
    const data = {
        nome,
        amount,
        min_amount,
        description,
        buyingPrice,
        sellingPrice,
        providerCNPJ,
        img_url
    };

    // Check if productId is null or not
    if (productId === null) {
        // Insert a new product
        fetch("/products/insert", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.status === 201) {
                return response.text();
            } else {
                throw new Error("Failed to insert product");
            }
        })
        .then(responseText => {
            alert(responseText);
        })
        .catch(error => {
            alert(error);
        });
    } else {
        // Update an existing product
        fetch(`/products/update/${productId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.status === 200) {
                return response.text();
            } else {
                throw new Error("Failed to update product");
            }
        })
        .then(responseText => {
            alert(responseText);
        })
        .catch(error => {
            alert(error);
        });
    }
}
    
    function openImageInput() {
    // Show the input field for the image URL
    const inputImageUrl = document.getElementById("inputImageUrl");
    inputImageUrl.style.display = "block";

    // Change the button text to "Salvar" and set its click action
    const btnAddImg = document.getElementById("btnAddImg");
    btnAddImg.innerText = "Salvar";
    btnAddImg.removeEventListener("click", openImageInput);
    btnAddImg.addEventListener("click", saveImage);

    // Focus on the input field for user convenience
    inputImageUrl.focus();
}

// Function to save the image URL and update the image source
function saveImage() {
    // Get the image URL from the input field
    const imageUrl = document.getElementById("inputImageUrl").value;

    // Update the image source if a valid URL is provided
    const campoImagem = document.getElementById("campoImagem");
    
    campoImagem.src = imageUrl;

    // Hide the input field and revert the button text and action
    const inputImageUrl = document.getElementById("inputImageUrl");
    inputImageUrl.style.display = "none";

    const btnAddImg = document.getElementById("btnAddImg");
    btnAddImg.innerText = "Adicionar Imagem";
    btnAddImg.removeEventListener("click", saveImage);
    btnAddImg.addEventListener("click", openImageInput);
}

function isValidImageUrl(url) {
    return url.trim() !== "";
}
</script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qw" </script>
</body>
</html>
